Finance
library(mongolite)
library(twitteR)
library(stringr)
library(tm)
library(plyr)
library(rjson)
library(httr)
library(RJSONIO) 


users <- mongo(collection = "users", db = "r_db", url = "mongodb://localhost", verbose = TRUE)
user_names <- mongo(collection = "user_info", db = "r_db", url = "mongodb://localhost", verbose = TRUE)

currentDate<-Sys.Date()
month<-format(currentDate,"%m")
year<-format(currentDate,"%Y")
#month <- 10

#year <- 2016
###########################################Financial data###############################################

update_bank_summary <- function(name) {
  account <- mongo(collection = name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  
  each_bank_balance <- account$aggregate( 
    
    '[{"$match":{"account_number": { "$exists": true}}},{"$group":{"_id":"$bank_name", "balance": {"$last":"$balance"}}}]' 
    
  )
  
  print(each_bank_balance)
  
  if(dim(each_bank_balance)[1] > 0 && dim(each_bank_balance)[2] > 0)
  {
    sum = 0
    for(balance in each_bank_balance[,2]) {
      sum <- sum + balance
    }
    no_of_accounts <- dim(each_bank_balance)[1]
    print(no_of_accounts)
    users$update(query = paste0('{"name":"', name,'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"no_of_accounts": ', no_of_accounts, '}}'))
    
  }
  
  each_accounts_balance <- account$aggregate( 
    
    '[{"$match":{"account_number": { "$exists": true}}},{"$group":{"_id":"$account_number", "balance": {"$last":"$balance"}}}]' 
    
  )
  if(dim(each_accounts_balance)[1] > 0 && dim(each_accounts_balance)[2] > 0)
  {
    sum = 0
    for(balance in each_accounts_balance[,2]) {
      sum <- sum + balance
    }
    users$update(query = paste0('{"name":"', name, '","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"total_bank_balance": ', sum, '}}'))
    no_of_accounts <- dim(each_accounts_balance)[1]
    print(no_of_accounts)
    users$update(query = paste0('{"name":"', name, '","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"no_of_accounts": ', no_of_accounts, '}}'))
  }
}



update_banks <- function(name) {
  account <- mongo(collection = name , db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  each_account_credit_summary <- account$aggregate( 
    
    paste0('[ {"$match": {"account_number": { "$exists": true}, "type":"credit", "month" : ', as.integer(month) , ',"year" :', year, '}},
           {"$group":{"_id":{"account_number":"$account_number"}, "amount": {"$sum":"$amount"}, "number_of_transcations": {"$sum":1} }}]')
    )
  each_account_debit_summary <- account$aggregate( 
    
    paste0('[ {"$match": {"account_number": { "$exists": true}, "type":"debit", "month" : ', as.integer(month) , ',"year" :', year, '}},
           {"$group":{"_id":{"account_number":"$account_number"}, "amount": {"$sum":"$amount"}, "number_of_transcations": {"$sum":1} }}]')
    )
  each_account_balance_bankname <- account$aggregate(
    '
    [ {"$match": {"account_number": { "$exists": true}}},
    {"$group":{"_id":{"account_number":"$account_number"}, "balance": {"$last":"$balance"},"bank_name": {"$last":"$bank_name"} }}]
    '
  )
  
  bank_collection_name <- paste(name,"_summary",sep="")
  summary_col <- mongo(collection = bank_collection_name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  
  #print(each_account_balance_bankname)
  #print(each_account_credit_summary)
  #print(each_account_debit_summary)
  nrows <- nrow(each_account_balance_bankname)
  for(i in 1:nrows){
    
    account_number <- each_account_balance_bankname[i,1]
    balance <- each_account_balance_bankname[i,2]
    bank_name <-  each_account_balance_bankname[i,3]
    
    summary_col$update(query = paste0('{"account_number":"', account_number[[1]],'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"type" : "account", "balance": ', balance , ',"bank_name":"', bank_name,'"}}'), upsert = TRUE)
    
  }
  
  nrows <- nrow(each_account_credit_summary)
  if(nrows > 0) {
    for(i in 1:nrows){
      
      account_number <- each_account_credit_summary[i, 1]
      credit_amount <- each_account_credit_summary[i,2]
      credit_no_of_transactions <- each_account_credit_summary[i,3]
      #print(account_number)
      #print(credit_no_of_transactions)
      
      summary_col$update(query = paste0('{"account_number":"', account_number[[1]],'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"total_credit_amount": ', credit_amount , ',"total_credit_transactions":', credit_no_of_transactions,'}}'), upsert = TRUE)
      
    }
  }
  nrows <- nrow(each_account_debit_summary)
  if(nrows > 0) {
    for(i in 1:nrows){
      
      account_number <- each_account_debit_summary[i, 1]
      debit_amount <- each_account_debit_summary[i,2]
      debit_no_of_transactions <- each_account_debit_summary[i,3]
      #print(account_number)
      #print(credit_no_of_transactions)
      
      summary_col$update(query = paste0('{"account_number":"', account_number[[1]],'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"total_debit_amount": ', debit_amount , ',"total_debit_transactions":', debit_no_of_transactions,'}}'), upsert = TRUE)
      
    }
  }
  
}




update_finance_credit_debit <- function(name, twitter_handle) {
  #users$update( query = paste0('{"name":"', name,'"}'), update = paste0('{"$set":{"tweets_sentiment": ', get_tweets_sentiment(twitter_handle), '}}'))
  account <- mongo(collection = name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  
  transactions_info_credit <- account$aggregate(
    
    paste0( '[{"$match":{"type":"credit", "month" : ', as.integer(month) , ',"year" :', year, '}},{"$group":{"_id":"$type", "count": {"$sum":1}, "amount":{"$sum":"$amount"},"average":{"$avg":"$amount"}}}]' )
    
  )
  #, "month" : "10", "year" : "2016"
  transactions_info_debit <- account$aggregate(
    paste0( '[{"$match":{"type":"debit", "month" : ', as.integer(month) , ',"year" :', year, '}},{"$group":{"_id":"$type", "count": {"$sum":1}, "amount":{"$sum":"$amount"},"average":{"$avg":"$amount"}}}]' )
  )
  users$update(query = paste0('{"name":"', name, '","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"twitter_handle":"', twitter_handle, '"}}'), upsert = TRUE)
  
  if(dim(transactions_info_credit)[1] > 0 && dim(transactions_info_credit)[2] > 0)
  {
    users$update(query = paste0('{"name":"', name, '","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"number_transactions_credit": ', transactions_info_credit[2], '}}'), upsert = TRUE)
    users$update(query = paste0('{"name":"', name, '","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"totalamount_transactions_credit": ', transactions_info_credit[3], '}}'), upsert = TRUE)
    users$update(query = paste0('{"name":"', name, '","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"averageamount_transactions_credit": ', transactions_info_credit[4], '}}'), upsert = TRUE)
    
  }
  if(dim(transactions_info_debit)[1] > 0 && dim(transactions_info_debit)[2] > 0)
  {
    users$update(query = paste0('{"name":"', name,'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"averageamount_transactions_debit": ', transactions_info_debit[4], '}}'), upsert = TRUE)
    users$update(query = paste0('{"name":"', name,'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"number_transactions_debit": ', transactions_info_debit[2], '}}'), upsert = TRUE)
    users$update(query = paste0('{"name":"', name,'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"totalamount_transactions_debit": ', transactions_info_debit[3], '}}'), upsert = TRUE)
  }
}





update_location_data <- function(name) {
  account <- mongo(collection = name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  city_not_fetched <- account$aggregate(
    '
    [{"$match":{"type":"location", "country": {"$exists": false}}}]
    '
  )
  
  if(dim(city_not_fetched)[1] > 0 && dim(city_not_fetched)[2] > 0)
  {
    nrows <- nrow(city_not_fetched)
    for(i in 1:nrows){
      
      print(city_not_fetched)
      
      latitude <- city_not_fetched[i,3]
      longitude <- city_not_fetched[i,4]
      
      latlon <- paste(latitude,',',longitude,sep="")
      print(latlon)
      
      API_Key <- "AIzaSyAZI9adLQIuSi2-YESdSwlqJj087KH3DrU"
      #Google Maps API key skylinelabs account  AIzaSyAZI9adLQIuSi2-YESdSwlqJj087KH3DrU
      
      
      connectStr <- paste("https://maps.google.com/maps/api/geocode/json?key=",API_Key,"&latlng=",latlon, sep="")
      con <- url(connectStr)
      data.json <- fromJSON(paste(readLines(con), collapse=""))
      close(con)
      
      #print(data.json)
      
      country <- ""
      city <- ""
      i <- 0
      
      nrows <- lengths(data.json)
      for(i in 1:nrows){
        type <- data.json$results[[i]]$types[1]
        if(identical(type,"country")){
          country <- data.json$results[[i]]$address_components[[1]]$long_name[1]
          print(country)
        }
        
        if(identical(type,"locality")){
          city <- data.json$results[[i]]$address_components[[2]]$long_name[1]
          print(city)
        }
        
        if(identical(city,"")){
          city <- data.json$results[[i]]$address_components[[3]]$long_name[1]
          print(city)
        }
      }
      
      
      
      query <- account$update(query = paste0('{"latitude":', latitude,',"longitude":',longitude,'}'), update = paste0('{"$set":{"city":"', city, '","country":"',country,'"}}'), upsert=TRUE,  multiple=TRUE )
      #m <- mongo(collection = bank_collection_name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
      #m$update(query = paste0('{"account_number":"', account_number,'","type":"',transaction_type,'"}'), update = paste0('{"$set":{"amount": ', amount, ',"transactions_number":', numer_of_transactions, ',"balance":', balance, ',"bank_name":"', bank,'"}}'),upsert = TRUE)
    }
  }
}

update_summary_location_data <- function (name) {
  collection_name <- paste(name,"_summary",sep="")
  summary_collection <- mongo(collection = collection_name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  
  name_collection <- mongo(collection = name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  city_wise_location <- name_collection$aggregate( 
    
    paste0('[ {"$match": {"type":"location", "month" : ', as.integer(month) , ',"year" :', year, '}},
           {"$group":{"_id":{"city":"$city", "country":"$country"}, "number": {"$sum":1} }}]')
    )
  print(city_wise_location)
  nrows <- nrow(city_wise_location)
  if(nrows > 0) {
    for(i in 1:nrows){
      
      city <- city_wise_location[i,1][1]
      country <- city_wise_location[i,1][2]
      number <-  city_wise_location[i,2]
      print(city[[1]])
      print(country[[1]])
      print(number)
      
      summary_collection$update(query = paste0('{"city":"', city[[1]],'","country":"',country[[1]],'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"type" : "location", "number": ', number ,'}}'), upsert = TRUE)
      
      
    }
  }
}

update_loan_payment_data <- function(name) {
  
  usercol <- mongo(collection = "users", db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  payment_collection_name <- paste(name,"_payments",sep="")
  pay_col <- mongo(collection = payment_collection_name, db = "r_db", url = "mongodb://localhost", verbose = TRUE)
  payments_info <- pay_col$aggregate(
    '[{"$match":{"type":"EMI" }},{"$group":{"_id":"$type","sum_default": {"$sum": "$default_payment"}, "sum_timely":{"$sum":"$timely_payment"}}}]'
  )
  print(payments_info)
  nrows <- nrow(payments_info)
  if(nrows == 1) {
    ndefaults <- payments_info[1,2]
    ntimely <- payments_info[1,3]
    loan_hist_score <- as.integer(ntimely) / (as.integer(ntimely) + as.integer(ndefaults)) * 100
    print(loan_hist_score)
    usercol$update(query = paste0('{"name":"', name,'","month" : ', as.integer(month) , ',"year" :', year, '}'), update = paste0('{"$set":{"loan_history_score": ', loan_hist_score, '}}'), upsert = TRUE)
    
    
  }
  
  
}

print_userdb <- function(){
  users_info <- users$find()
  print(users_info)
}

update_all_data <- function() {
  users_info <- user_names$find()
  
  for (i in 1:nrow(users_info)) {
    name <- users_info[i, "name"]
    twitter_handle <- users_info[i, "twitter_handle"]
    
    update_finance_credit_debit(name, twitter_handle)
    update_bank_summary(name)
    update_banks(name)
    update_location_data(name)
    update_summary_location_data(name)
    update_loan_payment_data(name)
    
  }
}


update_all_data()
#print_userdb()

###########################################Financial data###############################################









Twitter
library(mongolite)
library(twitteR)
library(stringr)
library(tm)
require('sentR')
library(plyr)
library(rjson)

####################################Twitter Auth#################################################
api_key = 'RUmPyAIYfK9eMzIavtopngC21'
api_secret = 'pHIFNMYpzqzIgxnHAXdrXAU75fCg1foTruHCV3lkM8BGwTyBBM'
access_token = '2405586890-T11ug4N2p1qBFNBuNHLnc63zEsOw5vQUmqtcFAP'
access_token_secret = '59Qd4Ew50ssNeYcNfrT6HxvXUQ3ATI4A56PGLFpeMTFkz'
setup_twitter_oauth(api_key,api_secret,access_token,access_token_secret)
####################################Twitter Auth#################################################


####################################Load sentiments word file#################################################
projectDir = getwd()
dataDir = file.path(projectDir, 'data')
hu.liu.pos = scan(file.path(dataDir, 'opinion-lexicon-English', 'positive-words.txt'), what='character', comment.char=';')
hu.liu.neg = scan(file.path(dataDir, 'opinion-lexicon-English', 'negative-words.txt'), what='character', comment.char=';')
pos.words = c(hu.liu.pos, 'upgrade')
neg.words = c(hu.liu.neg, 'wtf', 'wait', 'waiting', 'epicfail', 'mechanical')
####################################Load sentiments word file#################################################
currentDate<-Sys.Date()
month<-format(currentDate,"%m")
year<-format(currentDate,"%Y")


users_summary <- mongo(collection = "user_info", db = "r_db", url = "mongodb://localhost", verbose = TRUE)
users<- mongo(collection = "users", db = "r_db", url = "mongodb://localhost", verbose = TRUE)


########################################Twitter Update##################################################
update_tweets_sentiment <- function() {
  users_info <- users_summary$find()
  for(twitter_handle in users_info[[2]]) {
    print(twitter_handle)
    users$update( query = paste0('{"twitter_handle":"', twitter_handle,'","month" : ', as.integer(month) , ',"year" :', year,'}'), update = paste0('{"$set":{"tweets_sentiment": ', get_tweets_sentiment(twitter_handle), '}}'))
  }
}

get_tweets_sentiment <- function(twitter_handle) {
  name_mentioned <- searchTwitter(paste0("from:", twitter_handle))
  print(name_mentioned)
  tweets.text <- sapply(name_mentioned, function(x) x$getText())
  tweets.text <- gsub("rt", "", tweets.text)
  tweets.text <- gsub("[[:punct:]]", "", tweets.text)
  tweets.text <- gsub("[ |\t]{2,}", "", tweets.text)
  tweets.text <- gsub("^ ", "", tweets.text)
  tweets.text <- gsub(" $", "", tweets.text)
  tweets.text <- tolower(tweets.text)
  tweets.text.corpus <- Corpus(VectorSource(tweets.text))
  tweets.text.corpus <- tm_map(tweets.text.corpus, function(x)removeWords(x,stopwords()))
  length <- length (tweets.text)
  sentiment_score <-0
  
  for (i in 1:length){
    all_tweets_string <- tweets.text[[i]]
    word.list = str_split(all_tweets_string, '\\s+')
    words = unlist(word.list)
    pos.matches = match(words, pos.words)
    neg.matches = match(words, neg.words)
    pos.matches = !is.na(pos.matches)
    neg.matches = !is.na(neg.matches)
    score = sum(pos.matches) - sum(neg.matches)
    sentiment_score <- sentiment_score + score
    print(score)
  }
  final <- sentiment_score/length
}

update_friends_followers_count <- function() {
  users_info <- users$find()
  for(twitter_handle in users_info[[2]]) {
    users$update(query = paste0('{"twitter_handle":"', twitter_handle,'","month" : ', as.integer(month) , ',"year" :', year,'}'), update = paste0('{"$set":{"twitter_followers_count": ', get_followers_count(twitter_handle), '}}'))
    users$update(query = paste0('{"twitter_handle":"', twitter_handle,'","month" : ', as.integer(month) , ',"year" :', year,'}'), update = paste0('{"$set":{"twitter_friends_count": ', get_friends_count(twitter_handle), '}}'))
  }
}

get_followers_count <- function(twitter_handle) {
  tweet <- getUser(twitter_handle)
  twitter_number_of_followers <-tweet$getFollowersCount()
}

get_friends_count <- function(twitter_handle) {
  tweet <- getUser(twitter_handle)
  twitter_number_of_friends<-tweet$getFriendsCount()
}

update_tweets_sentiment()
update_friends_followers_count()

########################################Twitter Update##################################################




users_info <- users$find()
print(users_info)
